{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
    #map-container {
        height: 400px;
        width: 100%;
        margin-bottom: 20px;
        border-radius: 8px;
        z-index: 0;
    }

    .location-search-box {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .location-search-box input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        color: #000;
    }
</style>
{% endblock %}

{% block after_field_sets %}
<div style="padding: 10px;">
    <h3 class="font-bold mb-2">ðŸ“Œ Pilih Lokasi Kantor (Google Maps)</h3>
    <p class="text-sm text-gray-500 mb-2">Geser pin di peta atau cari nama lokasi untuk mengisi Latitude & Longitude.
    </p>

    {% if google_maps_api_key %}
    <div class="location-search-box">
        <input type="text" id="search-location" placeholder="Cari alamat atau nama tempat (contoh: Monas, Jakarta)...">
    </div>
    <div id="map-container"></div>

    <script>
        function initMap() {
            var latInput = document.getElementById("id_latitude");
            var lngInput = document.getElementById("id_longitude");

            // Default: Monas if empty
            var defaultLat = -6.175392;
            var defaultLng = 106.827153;
            var zoomLevel = 13;

            if (latInput.value && lngInput.value) {
                try {
                    defaultLat = parseFloat(latInput.value.replace(',', '.'));
                    defaultLng = parseFloat(lngInput.value.replace(',', '.'));
                    zoomLevel = 17;
                } catch (e) { console.error("Error parsing coords", e); }
            }

            var center = { lat: defaultLat, lng: defaultLng };

            var map = new google.maps.Map(document.getElementById("map-container"), {
                zoom: zoomLevel,
                center: center,
                mapTypeId: "roadmap",
                streetViewControl: false,
            });

            var marker = new google.maps.Marker({
                position: center,
                map: map,
                draggable: true,
                title: "Lokasi Kantor"
            });

            // Update inputs when marker drags
            marker.addListener("dragend", function () {
                var pos = marker.getPosition();
                latInput.value = pos.lat().toFixed(6);
                lngInput.value = pos.lng().toFixed(6);
            });

            // Update marker when map is clicked
            map.addListener("click", function (e) {
                marker.setPosition(e.latLng);
                latInput.value = e.latLng.lat().toFixed(6);
                lngInput.value = e.latLng.lng().toFixed(6);
            });

            // Search Box
            var input = document.getElementById("search-location");
            var searchBox = new google.maps.places.SearchBox(input);

            // Bias the SearchBox results towards current map's viewport.
            map.addListener("bounds_changed", function () {
                searchBox.setBounds(map.getBounds());
            });

            searchBox.addListener("places_changed", function () {
                var places = searchBox.getPlaces();

                if (places.length == 0) {
                    return;
                }

                // For each place, get the icon, name and location.
                var bounds = new google.maps.LatLngBounds();
                places.forEach(function (place) {
                    if (!place.geometry || !place.geometry.location) {
                        console.log("Returned place contains no geometry");
                        return;
                    }

                    // Move marker to the first result
                    if (places.indexOf(place) === 0) {
                        marker.setPosition(place.geometry.location);
                        latInput.value = place.geometry.location.lat().toFixed(6);
                        lngInput.value = place.geometry.location.lng().toFixed(6);
                    }

                    if (place.geometry.viewport) {
                        // Only geocodes have viewport.
                        bounds.union(place.geometry.viewport);
                    } else {
                        bounds.extend(place.geometry.location);
                    }
                });
                map.fitBounds(bounds);
            });
        }
    </script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap&loading=async"
        async defer></script>
    {% else %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
        <strong class="font-bold">Google Maps API Key Missing!</strong>
        <span class="block sm:inline">Silakan tambahkan <code>GOOGLE_MAPS_API_KEY</code> di file <code>.env</code> Anda
            untuk menggunakan fitur peta ini.</span>
    </div>
    {% endif %}
</div>
{{ block.super }}
{% endblock %}